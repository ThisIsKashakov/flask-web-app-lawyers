{% extends "base.html" %}

{% block title %}
    Файлы дела - {{ case.title }}
{% endblock %}

{% block content %}
    <div class="container-fluid pt-3 px-4">
        <h2>Файлы дела: {{ case.title }}</h2>
        <p>Клиент: {{ case.full_name }}</p>

        <!-- Storage Info -->
        <div class="card mb-4">
            <div class="card-header">Информация о хранилище</div>
            <div class="card-body">
                <p class="mb-0">
                    <strong>Статус хранилища:</strong>
                    Использовано: {{ "%.2f"|format(storage_stats.used / 1024 / 1024 / 1024) }} GB | Свободно:
                    {{ "%.2f"|format(storage_stats.free / 1024 / 1024 / 1024) }} GB | Всего:
                    {{ "%.2f"|format(storage_stats.total / 1024 / 1024 / 1024) }} GB
                </p>
            </div>
        </div>

        <!-- Upload Form -->
        {% if storage_stats.free > 0 %}
            <div class="card mb-4">
                <div class="card-header">Загрузить новый файл</div>
                <div class="card-body">
                    <form
                        action="{{ url_for('routes.upload_file', case_id=case.id) }}"
                        method="post"
                        enctype="multipart/form-data"
                        class="mb-3"
                    >
                        <div class="form-group">
                            <div class="custom-file">
                                <input
                                    type="file"
                                    class="custom-file-input"
                                    id="file"
                                    name="file"
                                    required
                                />
                                <label class="custom-file-label" for="file">Выбрать файл</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Загрузить</button>
                    </form>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning" role="alert">
                Хранилище заполнено. Пожалуйста, освободите место перед загрузкой новых файлов.
            </div>
        {% endif %}

        <!-- Files List -->
        <div class="card">
            <div class="card-header">Файлы дела</div>
            <div class="card-body">
                {% if files %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Имя файла</th>
                                    <th>Размер</th>
                                    <th>Дата загрузки</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in files %}
                                    <tr>
                                        <td>{{ file.original_filename }}</td>
                                        <td>
                                            {% if file.file_size < 1024 %}
                                                {{ file.file_size }}
                                                B
                                            {% elif file.file_size < 1048576 %}
                                                {{ "%.1f"|format(file.file_size / 1024) }}
                                                KB
                                            {% elif file.file_size < 1073741824 %}
                                                {{ "%.1f"|format(file.file_size / 1048576) }}
                                                MB
                                            {% else %}
                                                {{ "%.1f"|format(file.file_size / 1073741824) }}
                                                GB
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ file.upload_date.strftime('%Y-%m-%d %H:%M:%S') }}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a
                                                    href="{{ url_for('routes.download_file', file_id=file.id) }}"
                                                    class="btn btn-sm btn-success"
                                                >
                                                    Скачать
                                                </a>
                                                <form
                                                    action="{{ url_for('routes.delete_file', file_id=file.id) }}"
                                                    method="post"
                                                    class="d-inline"
                                                    onsubmit="return confirm('Вы уверены, что хотите удалить этот файл?');"
                                                >
                                                    <button
                                                        type="submit"
                                                        class="btn btn-sm btn-danger"
                                                    >
                                                        Удалить
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">Файлы еще не загружены.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Bootstrap File Input JS -->
    <script>
        // Update file input label with selected filename
        document.querySelector(".custom-file-input").addEventListener("change", function (e) {
            var fileName = e.target.files[0].name;
            var label = e.target.nextElementSibling;
            label.textContent = fileName;
        });
    </script>
{% endblock %}
